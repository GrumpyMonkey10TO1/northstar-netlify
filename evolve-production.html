<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>North Star Academy - Evolve</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Aptos:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
  @font-face { font-family: 'Aptos'; src: local('Aptos'), local('Aptos Display'); font-weight: 400; }
  @font-face { font-family: 'Aptos'; src: local('Aptos Bold'), local('Aptos Display Bold'); font-weight: 700; }

  :root { 
    --bg: #FFD1E3; --panel: #A367B1; --user: #8A4F9F; --ink: #E8ECEB;
    --radius: 22px; --header-height: 120px; --footer-height: 120px;
    --brand: var(--panel); --line: rgba(255,255,255,0.1);
    --brand-30: color-mix(in srgb, var(--panel) 30%, transparent);
    --brand-35: color-mix(in srgb, var(--panel) 35%, transparent);
  }

  * { box-sizing: border-box; }
  html, body { margin: 0; padding: 0; width: 100%; height: 100%; background: var(--bg); font-family: 'Aptos', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; color: var(--ink); overflow: hidden; }

  .mn-header-outer.evolve-header { background: var(--panel); width: 100%; height: var(--header-height); position: fixed; top: 0; left: 0; z-index: 9999; display: flex; justify-content: center; align-items: center; }
  .mn-header-inner { display: flex; justify-content: center; align-items: center; gap: 50px; width: 100%; max-width: 1200px; padding: 0 20px; }
  .mn-logo img { height: 38px; object-fit: contain; }
  .mn-nav { display: flex; align-items: center; gap: 20px; }
  .nav-tile { display: flex; flex-direction: column; align-items: center; text-decoration: none; padding: 8px 20px; border-radius: 12px; transition: all .25s ease; min-width: 140px; }
  .nav-tile:hover { background: rgba(255,255,255,.3); transform: translateY(-2px); }
  .nav-tile.active { background: #fff; }
  .nav-tile .nav-name { font-size: 16px; font-weight: 700; color: #000; line-height: 1.2; }
  .nav-tile .nav-desc { font-size: 10px; font-weight: 500; color: rgba(0,0,0,0.7); text-align: center; line-height: 1.2; }

  #chat-input[disabled] { opacity: .45; cursor: not-allowed; }
  button[disabled] { opacity: .4; cursor: not-allowed; pointer-events: none; }
  .pay-btn { background: #FFD93D !important; color: #1A1A1A !important; font-weight: 700; border: 2px solid rgba(0,0,0,0.25) !important; }
  .pay-btn:hover { background: #FFEB7A !important; transform: translateY(-2px); }

  .mn-footer { background: var(--panel); width: 100%; height: var(--footer-height); position: fixed; bottom: 0; left: 0; display: flex; justify-content: center; align-items: center; z-index: 1000; }
  #main-content-area { position: fixed; top: var(--header-height); bottom: var(--footer-height); left: 0; right: 0; display: flex; justify-content: center; align-items: center; padding: 20px; overflow: auto; }
  .mn-footer-inner { width: 100%; max-width: 850px; display: flex; justify-content: space-between; align-items: center; }
  .footer-left, .footer-center, .footer-right { display: flex; flex-direction: column; align-items: center; }
  .footer-left img { width: 60px; margin-bottom: 3px; }
  .footer-left .license-number, .footer-email, .footer-right span { color: #000; font-weight: 700; text-decoration: none; font-size: 0.8rem; }
  .footer-right span { font-size: .75rem; line-height: 1.1; }

  .contrast-panel { background: var(--panel); border-radius: var(--radius); padding: 24px; max-width: 1100px; width: 92%; box-shadow: 0 12px 48px rgba(163,103,177,0.25); animation: fadeIn 0.6s ease; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
  .ns-grid { display: flex; width: 100%; gap: 28px; align-items: flex-start; }

  .chat-box { flex: 2.5; display: flex; flex-direction: column; background: #000; border: 1px solid var(--line); border-radius: var(--radius); height: 580px; overflow: hidden; margin-right: 6px; }
  #progress-container { display: flex; flex-direction: column; background: rgba(35,45,65,0.9); padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); gap: 10px; position: relative; }
  .action-buttons-bar { display: flex; gap: 8px; flex-wrap: wrap; width: 100%; }
  .desktop-actions { display: flex; gap: 6px; flex: 1; width: 100%; }
  .mobile-actions { display: none; width: 100%; flex: 1; }

  .action-btn { flex: 1; min-width: 70px; padding: 8px 6px; border-radius: 8px; background: rgba(163,103,177,0.3); border: 1px solid rgba(163,103,177,0.5); color: #fff; font-weight: 600; font-size: 11px; cursor: pointer; transition: all 0.2s ease; font-family: 'Aptos', sans-serif; white-space: nowrap; position: relative; }
  .action-btn:hover { background: rgba(163,103,177,0.5); border-color: var(--panel); transform: translateY(-2px); }
  .action-btn.danger { background: rgba(255,80,80,0.25); border: 1px solid rgba(255,80,80,0.5); }
  .action-btn-inner { flex: 1; width: 100%; padding: 8px 10px; border-radius: 8px; background: rgba(163,103,177,0.3); border: 1px solid rgba(163,103,177,0.5); color: #fff; font-weight: 600; font-size: 12px; cursor: pointer; transition: all 0.2s ease; font-family: 'Aptos', sans-serif; }
  .action-btn-inner:hover { background: rgba(163,103,177,0.5); border-color: var(--panel); transform: translateY(-2px); }
  .action-btn-inner.danger { background: rgba(255,80,80,0.25); border: 1px solid rgba(255,80,80,0.5); }

  #mobile-menu-dropdown { display: none; background: rgba(20, 20, 40, 0.95); border-radius: 8px; padding: 6px; border: 1px solid var(--brand-30); width: 100%; gap: 6px; flex-direction: column; margin-top: 6px; }
  #mobile-menu-dropdown.active { display: flex; }
  #stats-dropdown { display: none; background: rgba(20,20,40,0.95); border-radius: 8px; padding: 10px; border: 1px solid rgba(163,103,177,0.3); width: 100%; max-width: 280px; position: absolute; top: 100%; left: 0; margin-top: 6px; z-index: 1000; }
  #stats-dropdown.active { display: block; }
  .stats-item { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid rgba(163,103,177,0.2); font-size: 11px; font-weight: 600; color: #E8ECEB; }
  .stats-item:last-child { border-bottom: none; }
  .stats-value { color: #FFD1E3; font-weight: 700; }

  #quicklinks-dropdown { display: none; background: rgba(20,20,40,0.95); border-radius: 8px; padding: 8px; border: 1px solid rgba(163,103,177,0.3); width: 260px; position: absolute; top: 100%; right: 0; margin-top: 6px; z-index: 1000; }
  #quicklinks-dropdown.active { display: block; }
  .quicklink-item { display: block; padding: 8px 10px; color: #fff; text-decoration: none; font-size: 12px; font-weight: 600; border-radius: 6px; transition: all 0.2s ease; }
  .quicklink-item:hover { background: rgba(163,103,177,0.4); }

  #notebookPanel { position: fixed; top: var(--header-height); right: -420px; width: 400px; height: calc(100vh - var(--header-height) - var(--footer-height)); background: #FFD1E3; box-shadow: -4px 0 20px rgba(0,0,0,0.2); z-index: 10000; transition: right 0.3s ease; display: flex; flex-direction: column; }
  #notebookPanel.open { right: 0; }
  .notebook-header { background: var(--panel); padding: 16px; display: flex; justify-content: space-between; align-items: center; }
  .notebook-header h3 { margin: 0; color: #fff; font-size: 16px; }
  .notebook-close { background: rgba(255,255,255,0.2); border: none; color: #fff; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-size: 16px; }
  .notebook-close:hover { background: rgba(255,255,255,0.3); }
  .notebook-body { flex: 1; padding: 16px; display: flex; flex-direction: column; }
  #notebookArea { flex: 1; width: 100%; border: 2px solid var(--panel); border-radius: 8px; padding: 12px; font-family: 'Aptos', sans-serif; font-size: 14px; resize: none; background: #fff; color: #1A1A1A; }
  #notebookArea:focus { outline: none; border-color: #8A4F9F; }
  .notebook-footer { padding: 12px 16px; background: rgba(163,103,177,0.1); font-size: 11px; color: #666; text-align: center; }

  #chat-body { flex: 1; padding: 14px; overflow-y: auto; font-size: 14px; scroll-behavior: smooth; }
  #chat-body::-webkit-scrollbar { width: 5px; }
  #chat-body::-webkit-scrollbar-thumb { background: var(--brand-30); border-radius: 3px; }
  #chat-footer { display: flex; flex-direction: column; gap: 10px; padding: 14px; background: rgba(35,45,65,0.9); border-top: 1px solid rgba(255,255,255,0.1); }
  #test-info { display: none; justify-content: space-between; align-items: center; padding: 6px 10px; background: rgba(163,103,177,0.2); border-radius: 8px; border: 1px solid rgba(163,103,177,0.3); }
  #test-info.active { display: flex; }
  .info-item { display: flex; align-items: center; gap: 5px; font-size: 12px; font-weight: 600; color: #FFD1E3; }
  #timer { color: #FFD1E3; font-size: 14px; font-weight: 700; }
  #timer.warning { color: #FFD93D; }
  #timer.danger { color: #FF6B6B; animation: pulse 1s infinite; }
  @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
  #word-count { color: #FFD1E3; font-size: 14px; font-weight: 700; }
  #word-count.low { color: #FF6B6B; }
  #word-count.good { color: #4CAF50; }
  #input-area { display: flex; gap: 10px; align-items: stretch; }
  .button-row { display: flex; gap: 10px; }
  #chat-input { flex: 1; min-height: 80px; max-height: 160px; resize: vertical; border-radius: 14px; border: 1px solid var(--brand-30); background: #111; color: var(--ink); padding: 14px; font-family: 'Aptos', sans-serif; font-size: 14px; outline: none; transition: border .2s; }
  #chat-input:focus { border-color: var(--panel); }
  #chat-send, #chat-refine, #chat-skip { padding: 14px 18px; border-radius: 14px; font-weight: 600; cursor: pointer; transition: all .2s; font-family: 'Aptos', sans-serif; }
  #chat-send { background: var(--panel); color: #fff; border: none; }
  #chat-send:hover:not([disabled]) { background: #8A4F9F; }
  #chat-refine { background: transparent; color: var(--panel); border: 2px solid var(--panel); }
  #chat-refine:hover:not([disabled]) { background: rgba(163,103,177,0.2); }
  #chat-skip { background: rgba(255,255,255,0.1); color: #aaa; border: 1px solid rgba(255,255,255,0.2); display: none; }
  #chat-skip:hover { background: rgba(255,255,255,0.2); }
  #chat-skip.visible { display: block; }

  .logged-in-bar { display: none; padding: 6px 10px; background: rgba(76, 175, 80, 0.15); border: 1px solid rgba(76, 175, 80, 0.3); border-radius: 6px; font-size: 11px; color: #4CAF50; font-weight: 600; }
  .logged-in-bar.visible { display: block; }

  .side-panel { flex: 1.2; background: #000; border: 1px solid var(--line); border-radius: var(--radius); padding: 16px; height: 580px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; }
  .side-panel::-webkit-scrollbar { width: 4px; }
  .side-panel::-webkit-scrollbar-thumb { background: var(--brand-30); border-radius: 3px; }
  .avatar-box { text-align: center; padding-bottom: 12px; border-bottom: 1px solid rgba(255,255,255,0.1); }
  .avatar-box img { width: 180px; height: auto; border-radius: 16px; }
  .faq-box { display: flex; flex-direction: column; gap: 8px; }
  .faq-box h3 { margin: 10px 0 6px; color: #FFD1E3; font-size: 13px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 6px; }
  .ns-btn { background: rgba(163,103,177,0.25); border: 1px solid rgba(163,103,177,0.35); color: #fff; padding: 10px 14px; border-radius: 10px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all .2s ease; text-align: left; width: 100%; font-family: 'Aptos', sans-serif; }
  .ns-btn:hover { background: rgba(163,103,177,0.45); transform: translateY(-1px); }
  .folder-header, .sub-folder-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 14px; background: rgba(163,103,177,0.15); border: 1px solid rgba(163,103,177,0.25); border-radius: 10px; cursor: pointer; font-size: 12px; font-weight: 600; transition: all .2s ease; }
  .folder-header:hover, .sub-folder-header:hover { background: rgba(163,103,177,0.3); }
  .folder-header .arrow, .sub-folder-header .arrow { transition: transform .2s ease; font-size: 10px; }
  .folder-header.open .arrow, .sub-folder-header.open .arrow { transform: rotate(90deg); }
  .test-list, .sub-test-list { display: none; flex-direction: column; gap: 4px; padding-left: 10px; margin-top: 6px; }
  .test-list.open, .sub-test-list.open { display: flex; }
  .test-btn { background: rgba(163,103,177,0.2); border: 1px solid rgba(163,103,177,0.3); color: #fff; padding: 8px 12px; border-radius: 8px; font-size: 11px; font-weight: 600; cursor: pointer; transition: all .2s ease; text-align: left; font-family: 'Aptos', sans-serif; }
  .test-btn:hover { background: rgba(163,103,177,0.4); transform: translateX(4px); }
  .test-btn.completed { background: rgba(76, 175, 80, 0.2); border-color: rgba(76, 175, 80, 0.4); }
  .test-btn.completed::after { content: " ‚úì"; color: #4CAF50; }

  .bubble { padding: 12px 16px; border-radius: 16px; max-width: 90%; margin: 6px 0; line-height: 1.6; animation: bubbleIn .3s ease; word-wrap: break-word; }
  @keyframes bubbleIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
  .bot { background: linear-gradient(135deg, var(--brand-30), var(--brand-35)); align-self: flex-start; border: 1px solid rgba(163,103,177,0.3); }
  .user { background: var(--user); align-self: flex-end; margin-left: auto; }
  .bot-row { display: flex; align-items: flex-start; gap: 10px; }
  .bot-row img { width: 32px; height: 32px; border-radius: 50%; margin-top: 6px; }
  .typing-indicator { display: flex; gap: 4px; padding: 12px 18px; }
  .typing-indicator span { width: 8px; height: 8px; border-radius: 50%; background: rgba(255,255,255,0.5); animation: typingDot 1.2s infinite ease-in-out; }
  .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
  .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
  @keyframes typingDot { 0%, 60%, 100% { transform: translateY(0); opacity: 0.5; } 30% { transform: translateY(-6px); opacity: 1; } }

  /* Score Display Styles */
  .score-card { background: rgba(0,0,0,0.3); border-radius: 12px; padding: 16px; margin-top: 10px; }
  .score-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); }
  .overall-score { font-size: 32px; font-weight: 700; color: #FFD93D; }
  .score-label { font-size: 12px; color: #aaa; }
  .score-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 12px; }
  .score-item { background: rgba(163,103,177,0.2); padding: 10px; border-radius: 8px; }
  .score-item-label { font-size: 10px; color: #aaa; text-transform: uppercase; }
  .score-item-value { font-size: 18px; font-weight: 700; color: #fff; }
  .feedback-section { margin-top: 12px; }
  .feedback-title { font-size: 12px; font-weight: 700; color: #FFD1E3; margin-bottom: 6px; }
  .feedback-text { font-size: 12px; color: #ccc; line-height: 1.5; }
  .strength-list, .improve-list { margin: 8px 0; padding-left: 16px; }
  .strength-list li { color: #4CAF50; font-size: 12px; margin: 4px 0; }
  .improve-list li { color: #FF9800; font-size: 12px; margin: 4px 0; }

  @media (max-width: 900px) {
    .ns-grid { flex-direction: column; }
    .chat-box, .side-panel { width: 100%; max-width: 100%; flex: none; }
    .chat-box { height: 500px; margin-right: 0; margin-bottom: 20px; }
    .side-panel { height: auto; max-height: 400px; }
    .desktop-actions { display: none; }
    .mobile-actions { display: flex; }
    .mn-header-inner { gap: 10px; padding: 0 10px; flex-wrap: wrap; justify-content: center; }
    .nav-tile { min-width: 80px; padding: 6px 10px; }
    .nav-tile .nav-name { font-size: 12px; }
    .nav-tile .nav-desc { font-size: 8px; }
    .mn-logo img { height: 28px; }
    :root { --header-height: 90px; --footer-height: 100px; }
    #notebookPanel { width: 100%; right: -100%; }
    .contrast-panel { padding: 14px; width: 96%; }
    .mn-footer-inner { flex-direction: column; gap: 8px; text-align: center; padding: 10px; }
    .footer-left, .footer-center, .footer-right { width: 100%; }
  }
</style>
</head>
<body>

<div class="mn-header-outer evolve-header">
  <div class="mn-header-inner">
    <a href="https://migratenorth.ca" class="mn-logo"><img src="https://migratenorth.ca/wp-content/uploads/2025/06/matin-logo-simple.png" alt="Logo"></a>
    <nav class="mn-nav">
      <a href="https://migratenorth.ca/explore/" class="nav-tile"><span class="nav-name">Explore</span><span class="nav-desc">Immigration Guidance</span></a>
      <a href="https://migratenorth.ca/evolve/" class="nav-tile active"><span class="nav-name">Evolve</span><span class="nav-desc">Language Proficiency</span></a>
      <a href="https://migratenorth.ca/elevate/" class="nav-tile"><span class="nav-name">Elevate</span><span class="nav-desc">Nursing & Licensing Path</span></a>
      <a href="https://migratenorth.ca/execute/" class="nav-tile"><span class="nav-name">Execute</span><span class="nav-desc">Immigration File Support</span></a>
    </nav>
  </div>
</div>

<div id="notebookPanel">
  <div class="notebook-header"><h3>üìì My Notebook</h3><button class="notebook-close" id="notebook-close">‚úï</button></div>
  <div class="notebook-body"><textarea id="notebookArea" placeholder="Take notes during your training..."></textarea></div>
  <div class="notebook-footer">Notes are saved automatically to your browser</div>
</div>

<div id="main-content-area">
  <div class="contrast-panel">
    <div class="ns-grid">
      <div class="chat-box" id="chatbox">
        <div id="progress-container">
          <div class="action-buttons-bar desktop-actions">
            <button class="action-btn" id="btn-stats">üìä Stats</button>
            <button class="action-btn" id="btn-download">üì• Download</button>
            <button class="action-btn" id="btn-notebook">üìì Notebook</button>
            <button class="action-btn" id="btn-quicklinks">üîó Resources</button>
            <button class="action-btn danger" id="btn-reset">‚ôªÔ∏è Reset</button>
            <button class="action-btn" id="btn-login">Login</button>
          </div>
          <div class="action-buttons-bar mobile-actions"><button class="action-btn" id="btn-mobile-menu">‚ò∞ Menu</button></div>
          <div id="mobile-menu-dropdown">
            <button class="action-btn-inner" id="btn-stats-mobile">üìä Stats</button>
            <button class="action-btn-inner" id="btn-download-mobile">üì• Download</button>
            <button class="action-btn-inner" id="btn-notebook-mobile">üìì Notebook</button>
            <button class="action-btn-inner" id="btn-quicklinks-mobile">üîó Resources</button>
            <button class="action-btn-inner danger" id="btn-reset-mobile">‚ôªÔ∏è Reset</button>
            <button class="action-btn-inner" id="btn-login-mobile">Login</button>
          </div>
          <div class="logged-in-bar" id="logged-in-bar">‚úì Logged in as <span id="logged-in-email"></span></div>
          <!-- Daily Plan Runner Box -->
<div id="daily-plan-box" style="display:none;background:rgba(163,103,177,0.18);border:1px solid rgba(163,103,177,0.4);border-radius:10px;padding:10px;margin-top:8px;font-size:11px;color:#fff">
  <strong>üìã Today's Plan</strong>
  <div id="daily-plan-steps"></div>
</div>
          <div id="stats-dropdown">
            <div class="stats-item"><span>Total Tests:</span><span class="stats-value" id="stat-tests">0/66</span></div>
            <div class="stats-item"><span>Writing:</span><span class="stats-value" id="stat-writing">0</span></div>
            <div class="stats-item"><span>Reading:</span><span class="stats-value" id="stat-reading">0</span></div>
            <div class="stats-item"><span>Micro Drills:</span><span class="stats-value" id="stat-micro">0</span></div>
            <div class="stats-item"><span>Words Learned:</span><span class="stats-value" id="stat-vocab-total">0</span></div>
<div class="stats-item"><span>Words Due:</span><span class="stats-value" id="stat-vocab-due">0</span></div>
<div class="stats-item"><span>Mastered:</span><span class="stats-value" id="stat-vocab-mastered">0</span></div>
            <div class="stats-item"><span>Avg Score:</span><span class="stats-value" id="stat-avg">-- </span></div>
            <div class="stats-item"><span>Best Score:</span><span class="stats-value" id="stat-best">--</span></div>
            <div class="stats-item"><span>Streak:</span><span class="stats-value" id="stat-streak">0 days</span></div>
            <div class="stats-item"><span>Practice Time:</span><span class="stats-value" id="stat-time">0 min</span></div>
          </div>
          <div id="quicklinks-dropdown">
            <a href="https://www.canada.ca/en/immigration-refugees-citizenship/services/immigrate-canada/express-entry.html" target="_blank" class="quicklink-item">üçÅ IRCC Express Entry</a>
            <a href="https://www.canada.ca/en/immigration-refugees-citizenship/services/application/account.html" target="_blank" class="quicklink-item">üçÅ IRCC Account Portal</a>
            <a href="https://www.wes.org/ca/" target="_blank" class="quicklink-item">üìú WES Canada</a>
            <a href="https://www.ielts.org/" target="_blank" class="quicklink-item">üìù IELTS Official</a>
            <a href="https://www.celpip.ca/" target="_blank" class="quicklink-item">üìù CELPIP Official</a>
            <a href="https://www.nnas.ca/" target="_blank" class="quicklink-item">üè• NNAS for Nurses</a>
            <a href="https://www.jobbank.gc.ca/" target="_blank" class="quicklink-item">üíº Job Bank Canada</a>
          </div>
        </div>
        <div id="chat-body"></div>
        <div id="chat-footer">
          <div id="test-info">
            <div class="info-item"><span>‚è±Ô∏è Time:</span><span id="timer">40:00</span></div>
            <div class="info-item"><span>üìù Words:</span><span id="word-count">0</span><span id="word-target">/250</span></div>
            <div class="info-item"><span id="test-level-badge"></span></div>
          </div>
          <div id="input-area">
            <textarea id="chat-input" placeholder="Login required to use Evolve" disabled></textarea>
            <div class="button-row">
              <button id="chat-send" disabled>Submit</button>
              <button id="chat-refine" disabled>Refine</button>
              <button id="chat-skip">Skip ‚è≠Ô∏è</button>
            </div>
          </div>
        </div>
      </div>
      <div class="side-panel">
        <div class="avatar-box"><img src="https://migratenorth.ca/wp-content/uploads/2025/11/Gemini_Generated_Image_xe229lxe229lxe22-2.png" alt="Avatar"></div>
        <div id="faq-dashboard" class="faq-box">
          <h3>Start Here</h3>
          <button class="ns-btn" data-faq="how-bootcamp-works">How the Academy Works</button>
          <button class="ns-btn" data-faq="how-dashboard">How to Use This Dashboard</button>
          
          <h3>NorthStar GPS</h3>
          <button class="ns-btn" data-faq="speed-tips">Tips for Writing Faster</button>
          <button class="ns-btn" data-faq="accuracy-tips">Tips for Better Accuracy</button>
          <button class="ns-btn" data-faq="vocab-tips">How to Learn New Words</button>
          <button class="ns-btn" data-faq="grammar-rules">Rules of Grammar</button>
          <button class="ns-btn" data-faq="common-mistakes">Common Mistakes to Avoid</button>
          <button class="ns-btn" data-faq="essay-structure">How to Structure an Essay</button>
          
          <h3>Writing Practice</h3>
          <div class="folder-header" data-folder="writing"><span>Open Writing</span><span class="arrow">‚ñ∫</span></div>
          <div class="test-list" id="writing-tests">
            <div class="sub-folder-header" data-subfolder="writing-foundation"><span>Foundation (1-11)</span><span class="arrow">‚ñ∫</span></div>
            <div class="sub-test-list" id="writing-foundation-tests"></div>
            <div class="sub-folder-header" data-subfolder="writing-intermediate"><span>Intermediate (12-22)</span><span class="arrow">‚ñ∫</span></div>
            <div class="sub-test-list" id="writing-intermediate-tests"></div>
            <div class="sub-folder-header" data-subfolder="writing-advanced"><span>Advanced (23-33)</span><span class="arrow">‚ñ∫</span></div>
            <div class="sub-test-list" id="writing-advanced-tests"></div>
            <div class="sub-folder-header" data-subfolder="writing-micro"><span>Micro Drills</span><span class="arrow">‚ñ∫</span></div>
            <div class="sub-test-list" id="writing-micro-tests"></div>
            <button class="ns-btn" data-faq="random-writing">üé≤ Random Writing Test</button>
          </div>
          
          <h3>Reading Practice</h3>
          <div class="folder-header" data-folder="reading"><span>Open Reading</span><span class="arrow">‚ñ∫</span></div>
          <div class="test-list" id="reading-tests">
            <div class="sub-folder-header" data-subfolder="reading-foundation"><span>Foundation (1-11)</span><span class="arrow">‚ñ∫</span></div>
            <div class="sub-test-list" id="reading-foundation-tests"></div>
            <div class="sub-folder-header" data-subfolder="reading-intermediate"><span>Intermediate (12-22)</span><span class="arrow">‚ñ∫</span></div>
            <div class="sub-test-list" id="reading-intermediate-tests"></div>
            <div class="sub-folder-header" data-subfolder="reading-advanced"><span>Advanced (23-33)</span><span class="arrow">‚ñ∫</span></div>
            <div class="sub-test-list" id="reading-advanced-tests"></div>
            <div class="sub-folder-header" data-subfolder="reading-micro"><span>Micro Drills</span><span class="arrow">‚ñ∫</span></div>
            <div class="sub-test-list" id="reading-micro-tests"></div>
          </div>

          <h3>Score References</h3>
          <button class="ns-btn" data-faq="ielts-clb">IELTS to CLB Conversion</button>
          <button class="ns-btn" data-faq="celpip-clb">CELPIP to CLB Conversion</button>

          <h3>Program Information</h3>
          <button class="ns-btn" data-faq="about-program">About This Program</button>
          <button class="ns-btn" data-faq="pricing">Pricing and Access</button>
          <button class="ns-btn" data-faq="writing-review">üìù Request Writing Review</button>
          <button class="ns-btn pay-btn" id="unlock-evolve">Unlock Full Evolve Access</button>
        </div>
      </div>
    </div>
  </div>
</div>

<footer class="mn-footer">
  <div class="mn-footer-inner">
    <div class="footer-left"><img src="https://migratenorth.ca/wp-content/uploads/2025/06/RCIC_logo.png" alt="RCIC"><span class="license-number">RCIC License #R712582</span></div>
    <div class="footer-center"><a href="mailto:info@migratenorth.ca" class="footer-email">info@migratenorth.ca</a></div>
    <div class="footer-right"><span>¬© 2025 Migrate North Academy</span><span>Results depend on consistent practice.</span></div>
  </div>
</footer>

<script>
// =============================================================================
// EVOLVE v2.1 - FULL TEST ENGINE
// =============================================================================
const EvolveApp = (function() {
  "use strict";

  // ---------------------------------------------------------------------------
  // CONFIGURATION
  // ---------------------------------------------------------------------------
  const API_BASE = "https://startling-faun-f9dddb.netlify.app";
  const AVATAR = "https://migratenorth.ca/wp-content/uploads/2025/11/Gemini_Generated_Image_xe229lxe229lxe22-2.png";

  // ---------------------------------------------------------------------------
  // TEST BANK - ALL 33 WRITING TESTS
  // ---------------------------------------------------------------------------
  const TEST_BANK = {
    writing: {
      foundation: [
        { id: "W1", prompt: "Some people believe that students should be required to wear uniforms in school, while others think students should be free to choose their own clothing.\n\nDiscuss both views and give your own opinion.", type: "opinion", time: 40, minWords: 250 },
        { id: "W2", prompt: "Many people believe that social media has a negative impact on young people today.\n\nTo what extent do you agree or disagree with this statement?", type: "opinion", time: 40, minWords: 250 },
        { id: "W3", prompt: "Some people think that the best way to reduce crime is to give longer prison sentences. Others believe there are better ways to reduce crime.\n\nDiscuss both views and give your opinion.", type: "discussion", time: 40, minWords: 250 },
        { id: "W4", prompt: "In many cities, traffic congestion is becoming a serious problem.\n\nWhat are the causes of this problem? What solutions can you suggest?", type: "problem-solution", time: 40, minWords: 250 },
        { id: "W5", prompt: "Some people believe that children should start learning a foreign language in primary school. Others think children should begin foreign language study in secondary school.\n\nDiscuss both views and give your opinion.", type: "discussion", time: 40, minWords: 250 },
        { id: "W6", prompt: "Many people now work from home instead of traveling to an office every day.\n\nWhat are the advantages and disadvantages of working from home?", type: "advantages-disadvantages", time: 40, minWords: 250 },
        { id: "W7", prompt: "Some people believe that governments should spend money on public transportation rather than building new roads for cars.\n\nTo what extent do you agree or disagree?", type: "opinion", time: 40, minWords: 250 },
        { id: "W8", prompt: "Some people think that parents should teach children to be good members of society. Others believe that school is the best place to learn this.\n\nDiscuss both views and give your opinion.", type: "discussion", time: 40, minWords: 250 },
        { id: "W9", prompt: "In many countries, the amount of household waste is increasing every year.\n\nWhat are the main causes of this? What can governments and individuals do to solve this problem?", type: "problem-solution", time: 40, minWords: 250 },
        { id: "W10", prompt: "Some people believe that unpaid community service should be a compulsory part of high school education.\n\nTo what extent do you agree or disagree?", type: "opinion", time: 40, minWords: 250 },
        { id: "W11", prompt: "Online shopping is becoming more popular than shopping in stores.\n\nWhat are the advantages and disadvantages of this trend?", type: "advantages-disadvantages", time: 40, minWords: 250 }
      ],
      intermediate: [
        { id: "W12", prompt: "Some people argue that technological developments have led to the loss of traditional skills and ways of life, and these should be preserved.\n\nTo what extent do you agree or disagree?", type: "opinion", time: 40, minWords: 250 },
        { id: "W13", prompt: "Some people think that the government should invest more money in teaching science subjects at school, while others believe that art and music education is equally important.\n\nDiscuss both views and give your opinion.", type: "discussion", time: 40, minWords: 250 },
        { id: "W14", prompt: "Many young people today are leaving rural areas to live and work in cities.\n\nWhy is this happening? Do you think the advantages of this trend outweigh the disadvantages?", type: "two-part", time: 40, minWords: 250 },
        { id: "W15", prompt: "Some people believe that university education should be free for all students. Others think students should pay for their own university education.\n\nDiscuss both views and give your opinion.", type: "discussion", time: 40, minWords: 250 },
        { id: "W16", prompt: "In many countries, there is a growing gap between the rich and the poor.\n\nWhat problems does this cause? What measures can governments take to reduce this gap?", type: "problem-solution", time: 40, minWords: 250 },
        { id: "W17", prompt: "Some people think that competitive sports have a positive effect on children's education, while others believe they are harmful.\n\nDiscuss both views and give your opinion.", type: "discussion", time: 40, minWords: 250 },
        { id: "W18", prompt: "Some people believe that news media has too much influence on people's lives today, while others think the media plays an important role in society.\n\nDiscuss both views and give your opinion.", type: "discussion", time: 40, minWords: 250 },
        { id: "W19", prompt: "Many countries are now experiencing a significant increase in tourism.\n\nWhat are the advantages and disadvantages of tourism for the countries and local communities involved?", type: "advantages-disadvantages", time: 40, minWords: 250 },
        { id: "W20", prompt: "Some people believe that the best way to improve public health is by increasing the number of sports facilities. Others think this would have little effect and other measures are needed.\n\nDiscuss both views and give your opinion.", type: "discussion", time: 40, minWords: 250 },
        { id: "W21", prompt: "In many countries, traditional foods are being replaced by international fast food.\n\nWhy is this happening? Is this a positive or negative development?", type: "two-part", time: 40, minWords: 250 },
        { id: "W22", prompt: "Many people feel that the pace of modern life is too stressful, leading to physical and mental health problems.\n\nWhat are the causes of this stress? What solutions would you recommend?", type: "problem-solution", time: 40, minWords: 250 }
      ],
      advanced: [
        { id: "W23", prompt: "Some people argue that the purpose of prison should be to rehabilitate criminals, while others believe its main purpose should be to punish them.\n\nDiscuss both views and give your opinion.", type: "discussion", time: 40, minWords: 250 },
        { id: "W24", prompt: "Scientific research should be carried out and controlled by governments rather than private companies.\n\nTo what extent do you agree or disagree?", type: "opinion", time: 40, minWords: 250 },
        { id: "W25", prompt: "Some people believe that economic progress is the most important goal for developing countries, while others argue that environmental protection should be the priority.\n\nDiscuss both views and give your opinion.", type: "discussion", time: 40, minWords: 250 },
        { id: "W26", prompt: "Genetic engineering is becoming increasingly common in agriculture and medicine.\n\nWhat are the potential benefits and risks of this technology? Should there be limits on genetic research?", type: "two-part", time: 40, minWords: 250 },
        { id: "W27", prompt: "Some people argue that artificial intelligence will eventually replace many human jobs, causing widespread unemployment. Others believe AI will create new opportunities.\n\nDiscuss both perspectives and give your opinion.", type: "discussion", time: 40, minWords: 250 },
        { id: "W28", prompt: "Climate change is considered to be one of the biggest threats facing humanity today.\n\nWhat are the main causes of climate change? What steps can governments and individuals take to address this issue?", type: "problem-solution", time: 40, minWords: 250 },
        { id: "W29", prompt: "Some people believe that globalization has had a predominantly positive effect on the world, while others argue it has increased inequality between nations.\n\nDiscuss both views and give your opinion.", type: "discussion", time: 40, minWords: 250 },
        { id: "W30", prompt: "Some people argue that individuals have a responsibility to maintain their health and should pay for their own medical care if they lead unhealthy lifestyles.\n\nTo what extent do you agree or disagree?", type: "opinion", time: 40, minWords: 250 },
        { id: "W31", prompt: "Many democratic countries now have declining voter turnout, especially among young people.\n\nWhat factors contribute to this trend? What measures could increase political participation?", type: "two-part", time: 40, minWords: 250 },
        { id: "W32", prompt: "Some people believe that space exploration is a waste of resources and that money should be spent on solving problems on Earth. Others argue that space exploration has important benefits for humanity.\n\nDiscuss both views and give your opinion.", type: "discussion", time: 40, minWords: 250 },
        { id: "W33", prompt: "The world's population is aging rapidly, with a growing proportion of elderly people and fewer young people.\n\nWhat challenges does this demographic shift create? What solutions can you propose?", type: "problem-solution", time: 40, minWords: 250 }
      ]
    }
  };

  // ---------------------------------------------------------------------------
  // STATE
  // ---------------------------------------------------------------------------
  let currentUserEmail = null;
  let userIsSubscribed = false;
  let completedTests = [];
  let testScores = [];

  // Test Engine State
  const TestState = {
    IDLE: "idle",
    ACTIVE: "active",
    SUBMITTED: "submitted",
    SCORING: "scoring",
    COMPLETE: "complete"
  };

  let currentTest = {
    state: TestState.IDLE,
    id: null,
    type: null,
    prompt: null,
    level: null,
    startTime: null,
    timeLimit: 40,
    minWords: 250,
    timerInterval: null,
    remainingSeconds: 0,
    answer: ""
  };

  // ---------------------------------------------------------------------------
  // CHAT ENGINE
  // ---------------------------------------------------------------------------
  const ChatEngine = {
    body: null,
    input: null,
    sendBtn: null,
    refineBtn: null,
    skipBtn: null,
    isTyping: false,

    init() {
      this.body = document.getElementById("chat-body");
      this.input = document.getElementById("chat-input");
      this.sendBtn = document.getElementById("chat-send");
      this.refineBtn = document.getElementById("chat-refine");
      this.skipBtn = document.getElementById("chat-skip");

      this.sendBtn.addEventListener("click", () => this.handleSubmit());
      this.refineBtn.addEventListener("click", () => this.handleRefine());
      this.skipBtn.addEventListener("click", () => this.handleSkip());

      this.input.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          this.handleSubmit();
        }
      });

      // Word count tracking
      this.input.addEventListener("input", () => {
        if (currentTest.state === TestState.ACTIVE) {
          updateWordCount();
        }
      });
    },

    addBotMessage(text, isHTML = false) {
      const row = document.createElement("div");
      row.className = "bot-row";
      const img = document.createElement("img");
      img.src = AVATAR;
      const bubble = document.createElement("div");
      bubble.className = "bubble bot";
      if (isHTML) {
        bubble.innerHTML = text;
      } else {
        bubble.innerHTML = this.formatText(text);
      }
      row.appendChild(img);
      row.appendChild(bubble);
      this.body.appendChild(row);
      this.scrollDown();
      return bubble;
    },

    addUserMessage(text) {
      const bubble = document.createElement("div");
      bubble.className = "bubble user";
      bubble.textContent = text.length > 500 ? text.substring(0, 500) + "..." : text;
      this.body.appendChild(bubble);
      this.scrollDown();
    },

    showTyping() {
      this.isTyping = true;
      this.skipBtn.classList.add("visible");
      const row = document.createElement("div");
      row.className = "bot-row";
      row.id = "typing-indicator";
      const img = document.createElement("img");
      img.src = AVATAR;
      const bubble = document.createElement("div");
      bubble.className = "bubble bot typing-indicator";
      bubble.innerHTML = "<span></span><span></span><span></span>";
      row.appendChild(img);
      row.appendChild(bubble);
      this.body.appendChild(row);
      this.scrollDown();
    },

    hideTyping() {
      this.isTyping = false;
      this.skipBtn.classList.remove("visible");
      const indicator = document.getElementById("typing-indicator");
      if (indicator) indicator.remove();
    },

    formatText(text) {
      return text
        .replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>")
        .replace(/\n/g, "<br>")
        .replace(/‚Ä¢ /g, "‚Ä¢ ");
    },

    scrollDown() {
      this.body.scrollTop = this.body.scrollHeight;
    },

    clear() {
      this.body.innerHTML = "";
    },

    handleSubmit() {
      const text = this.input.value.trim();
      if (!text) return;

      if (currentTest.state === TestState.ACTIVE) {
        // Submit test answer
        submitTestAnswer(text);
      } else {
        // Regular chat (FAQ or general)
        this.addUserMessage(text);
        this.input.value = "";
        this.addBotMessage("Use the buttons on the right panel to navigate. Select a test to begin practicing!");
      }
    },

    handleRefine() {
      if (currentTest.state === TestState.COMPLETE && currentTest.answer) {
        this.showTyping();
        requestRefine(currentTest.answer, currentTest.prompt);
      }
    },

    handleSkip() {
      if (this.isTyping) {
        this.hideTyping();
        this.addBotMessage("Skipped. What would you like to do next?");
      }
    }
  };

  // ---------------------------------------------------------------------------
  // TIMER FUNCTIONS
  // ---------------------------------------------------------------------------
  function startTimer(minutes) {
    currentTest.remainingSeconds = minutes * 60;
    updateTimerDisplay();

    currentTest.timerInterval = setInterval(() => {
      currentTest.remainingSeconds--;
      updateTimerDisplay();

      if (currentTest.remainingSeconds <= 0) {
        clearInterval(currentTest.timerInterval);
        timeUp();
      }
    }, 1000);
  }

  function updateTimerDisplay() {
    const timerEl = document.getElementById("timer");
    const mins = Math.floor(currentTest.remainingSeconds / 60);
    const secs = currentTest.remainingSeconds % 60;
    timerEl.textContent = `${mins}:${secs.toString().padStart(2, "0")}`;

    // Color warnings
    timerEl.classList.remove("warning", "danger");
    if (currentTest.remainingSeconds <= 300 && currentTest.remainingSeconds > 60) {
      timerEl.classList.add("warning");
    } else if (currentTest.remainingSeconds <= 60) {
      timerEl.classList.add("danger");
    }
  }

  function stopTimer() {
    if (currentTest.timerInterval) {
      clearInterval(currentTest.timerInterval);
      currentTest.timerInterval = null;
    }
  }

  function timeUp() {
    ChatEngine.addBotMessage("‚è∞ **Time's up!** Your answer has been auto-submitted for scoring.");
    const answer = ChatEngine.input.value.trim();
    if (answer) {
      submitTestAnswer(answer);
    } else {
      ChatEngine.addBotMessage("No answer was provided. Try another test when you're ready.");
      endTest();
    }
  }

  // ---------------------------------------------------------------------------
  // WORD COUNT
  // ---------------------------------------------------------------------------
  function updateWordCount() {
    const text = ChatEngine.input.value.trim();
    const words = text ? text.split(/\s+/).filter(w => w.length > 0).length : 0;
    const wordCountEl = document.getElementById("word-count");
    wordCountEl.textContent = words;

    wordCountEl.classList.remove("low", "good");
    if (words < currentTest.minWords) {
      wordCountEl.classList.add("low");
    } else {
      wordCountEl.classList.add("good");
    }
  }

  // ---------------------------------------------------------------------------
  // TEST ENGINE
  // ---------------------------------------------------------------------------
  function startTest(testId, level) {
    // Find the test
    const levelTests = TEST_BANK.writing[level];
    const test = levelTests.find(t => t.id === testId);
    
    if (!test) {
      ChatEngine.addBotMessage("Test not found. Please try another.");
      return;
    }

    // Set up test state
    currentTest = {
      state: TestState.ACTIVE,
      id: testId,
      type: "writing",
      prompt: test.prompt,
      level: level,
      startTime: Date.now(),
      timeLimit: test.time,
      minWords: test.minWords,
      timerInterval: null,
      remainingSeconds: 0,
      answer: ""
    };

    // Update UI
    document.getElementById("test-info").classList.add("active");
    document.getElementById("word-target").textContent = `/${test.minWords}`;
    document.getElementById("test-level-badge").textContent = `üìö ${level.charAt(0).toUpperCase() + level.slice(1)}`;
    document.getElementById("word-count").textContent = "0";
    
    ChatEngine.input.value = "";
    ChatEngine.input.placeholder = "Write your response here...";
    ChatEngine.input.focus();

    // Show test prompt
    ChatEngine.addBotMessage(`**${testId} - ${test.type.charAt(0).toUpperCase() + test.type.slice(1)} Essay**\n\nüìù **Task:**\n${test.prompt}\n\n‚è±Ô∏è Time: ${test.time} minutes\nüìä Minimum: ${test.minWords} words\n\n**Tips:**\n‚Ä¢ Plan for 2-3 minutes before writing\n‚Ä¢ Address all parts of the question\n‚Ä¢ Leave time to review\n\nYour time starts now. Good luck!`);

    // Start timer
    startTimer(test.time);
  }

  async function submitTestAnswer(answer) {
    stopTimer();
    currentTest.answer = answer;
    currentTest.state = TestState.SCORING;

    const wordCount = answer.split(/\s+/).filter(w => w.length > 0).length;
    const timeSpent = Math.round((Date.now() - currentTest.startTime) / 1000);

    ChatEngine.addUserMessage(answer.length > 300 ? answer.substring(0, 300) + "... [truncated]" : answer);
    ChatEngine.input.value = "";
    
    ChatEngine.addBotMessage(`‚úÖ **Answer received!**\n\nüìù Words: ${wordCount}\n‚è±Ô∏è Time: ${Math.floor(timeSpent / 60)}m ${timeSpent % 60}s\n\nScoring your response with AI...`);
    ChatEngine.showTyping();

    try {
      const response = await fetch(`${API_BASE}/.netlify/functions/score-writing`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          email: currentUserEmail,
          testId: currentTest.id,
          prompt: currentTest.prompt,
          answer: answer,
          timeSpent: timeSpent
        })
      });

      ChatEngine.hideTyping();

      if (!response.ok) {
        throw new Error("Scoring failed");
      }

      const result = await response.json();
      displayScore(result);
      
      // Mark test as completed
      if (!completedTests.includes(currentTest.id)) {
        completedTests.push(currentTest.id);
        testScores.push({ id: currentTest.id, score: result.scores.overall, date: new Date().toISOString() });
        saveProgress();
        updateStats();
        markTestCompleted(currentTest.id);
      }

      currentTest.state = TestState.COMPLETE;

    } catch (error) {
      ChatEngine.hideTyping();
      console.error("Scoring error:", error);
      ChatEngine.addBotMessage("‚ö†Ô∏è **Scoring Error**\n\nUnable to score your response right now. Your answer has been saved.\n\nPlease try again or contact support if this continues.");
      currentTest.state = TestState.COMPLETE;
    }
  }

  function displayScore(result) {
    const scores = result.scores || {};
    const feedback = result.feedback || {};
    
    const scoreHTML = `
      <div class="score-card">
        <div class="score-header">
          <div>
            <div class="overall-score">${scores.overall || "--"}</div>
            <div class="score-label">Overall Band Score</div>
          </div>
          <div style="text-align: right;">
            <div style="color: #4CAF50; font-weight: 700;">${result.wordCount || 0} words</div>
            <div class="score-label">${currentTest.id} Complete</div>
          </div>
        </div>
        
        <div class="score-grid">
          <div class="score-item">
            <div class="score-item-label">Task Achievement</div>
            <div class="score-item-value">${scores.task || "--"}</div>
          </div>
          <div class="score-item">
            <div class="score-item-label">Coherence</div>
            <div class="score-item-value">${scores.coherence || "--"}</div>
          </div>
          <div class="score-item">
            <div class="score-item-label">Vocabulary</div>
            <div class="score-item-value">${scores.lexical || "--"}</div>
          </div>
          <div class="score-item">
            <div class="score-item-label">Grammar</div>
            <div class="score-item-value">${scores.grammar || "--"}</div>
          </div>
        </div>

        <div class="feedback-section">
          <div class="feedback-title">üí™ Strengths</div>
          <ul class="strength-list">
            ${(result.strengths || ["Good attempt"]).map(s => `<li>${s}</li>`).join("")}
          </ul>
        </div>

        <div class="feedback-section">
          <div class="feedback-title">üéØ Areas to Improve</div>
          <ul class="improve-list">
            ${(result.improvements || ["Keep practicing"]).map(i => `<li>${i}</li>`).join("")}
          </ul>
        </div>

        <div class="feedback-section">
          <div class="feedback-title">üìå Next Focus</div>
          <div class="feedback-text">${result.next_focus || "Continue practicing to improve your score."}</div>
        </div>
      </div>
    `;

    ChatEngine.addBotMessage(`**üìä Your Score Report**`, false);
    ChatEngine.addBotMessage(scoreHTML, true);
    ChatEngine.addBotMessage(`**Summary:** ${result.band_summary || "Keep up the practice!"}\n\nClick **Refine** to get suggestions for improving this specific response, or select another test to continue practicing.`);
    
    endTest();
  }

  function endTest() {
    currentTest.state = TestState.IDLE;
    document.getElementById("test-info").classList.remove("active");
    ChatEngine.input.placeholder = "Select a test from the right panel...";
  }

  function markTestCompleted(testId) {
    const buttons = document.querySelectorAll(".test-btn");
    buttons.forEach(btn => {
      if (btn.textContent.includes(testId.replace("W", "Writing Test "))) {
        btn.classList.add("completed");
      }
    });
  }

  // ---------------------------------------------------------------------------
  // REFINE FUNCTION
  // ---------------------------------------------------------------------------
  async function requestRefine(answer, prompt) {
    try {
      const response = await fetch(`${API_BASE}/.netlify/functions/chat-evolve`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          message: `Please analyze this IELTS essay and provide specific suggestions to improve it:\n\nPROMPT: ${prompt}\n\nSTUDENT'S ANSWER:\n${answer}\n\nProvide:\n1. Two specific sentences that could be improved (with rewrites)\n2. One vocabulary upgrade suggestion\n3. One structural improvement tip`,
          email: currentUserEmail
        })
      });

      ChatEngine.hideTyping();

      if (!response.ok) throw new Error("Refine failed");

      const data = await response.json();
      ChatEngine.addBotMessage(data.response || "Here are some suggestions for improvement...");

    } catch (error) {
      ChatEngine.hideTyping();
      ChatEngine.addBotMessage("Unable to generate refinements. Please try again.");
    }
  }

  // ---------------------------------------------------------------------------
  // AUTH & ACCESS
  // ---------------------------------------------------------------------------
  async function checkEntitlement(email) {
    try {
      const response = await fetch(`${API_BASE}/.netlify/functions/check-entitlement?email=${encodeURIComponent(email)}`);
      const data = await response.json();
      return data.hasAccess === true;
    } catch (error) {
      console.error("Entitlement check failed:", error);
      return false;
    }
  }

  function applyAccess(hasAccess, email) {
    userIsSubscribed = hasAccess;
    currentUserEmail = email;

    const input = ChatEngine.input;
    const sendBtn = ChatEngine.sendBtn;
    const refineBtn = ChatEngine.refineBtn;
    const loginBtn = document.getElementById("btn-login");
    const loginBtnMobile = document.getElementById("btn-login-mobile");
    const loggedInBar = document.getElementById("logged-in-bar");
    const loggedInEmail = document.getElementById("logged-in-email");
    const unlockBtn = document.getElementById("unlock-evolve");

    if (hasAccess && email) {
      input.disabled = false;
      input.placeholder = "Select a test from the right panel to begin...";
      sendBtn.disabled = false;
      refineBtn.disabled = false;
      loginBtn.textContent = "Logout";
      loginBtnMobile.textContent = "Logout";
      loggedInBar.classList.add("visible");
      loggedInEmail.textContent = email;
      unlockBtn.style.display = "none";
    } else {
      input.disabled = true;
      input.placeholder = "Login required to use Evolve";
      sendBtn.disabled = true;
      refineBtn.disabled = true;
      loginBtn.textContent = "Login";
      loginBtnMobile.textContent = "Login";
      loggedInBar.classList.remove("visible");
      unlockBtn.style.display = "block";
    }
  }

  async function handleLogin() {
    const email = prompt("Enter your email to login:");
    if (!email || !email.includes("@")) {
      alert("Please enter a valid email.");
      return;
    }

    ChatEngine.addBotMessage("Checking your access...");
    const hasAccess = await checkEntitlement(email.toLowerCase());

    if (hasAccess) {
      localStorage.setItem("evolve_user_email", email.toLowerCase());
      applyAccess(true, email.toLowerCase());
      loadProgress();
      ChatEngine.addBotMessage(`‚úÖ Welcome back! You have full access to Evolve.\n\nSelect a test from the right panel to begin practicing.`);
    } else {
      ChatEngine.addBotMessage(`‚ùå No active subscription found for ${email}.\n\nClick the yellow "Unlock Full Evolve Access" button to subscribe and get started!`);
    }
  }

  function handleLogout() {
    localStorage.removeItem("evolve_user_email");
    localStorage.removeItem("evolve_completed_tests");
    localStorage.removeItem("evolve_test_scores");
    applyAccess(false, null);
    completedTests = [];
    testScores = [];
    updateStats();
    ChatEngine.clear();
    showWelcome();
    ChatEngine.addBotMessage("You have been logged out. Login again or subscribe to continue.");
  }

  // ---------------------------------------------------------------------------
  // PROGRESS & STATS
  // ---------------------------------------------------------------------------
  function saveProgress() {
    localStorage.setItem("evolve_completed_tests", JSON.stringify(completedTests));
    localStorage.setItem("evolve_test_scores", JSON.stringify(testScores));
  }

  function loadProgress() {
    try {
      const saved = localStorage.getItem("evolve_completed_tests");
      const scores = localStorage.getItem("evolve_test_scores");
      if (saved) completedTests = JSON.parse(saved);
      if (scores) testScores = JSON.parse(scores);
      
      // Mark completed tests in UI
      completedTests.forEach(id => markTestCompleted(id));
      updateStats();
    } catch (e) {
      console.error("Error loading progress:", e);
    }
  }

  function updateStats() {
    document.getElementById("stat-tests").textContent = `${completedTests.length}/66`;
    document.getElementById("stat-writing").textContent = completedTests.filter(id => id.startsWith("W")).length;
    document.getElementById("stat-reading").textContent = completedTests.filter(id => id.startsWith("R")).length;
    
    if (testScores.length > 0) {
      const avg = testScores.reduce((sum, s) => sum + s.score, 0) / testScores.length;
      const best = Math.max(...testScores.map(s => s.score));
      document.getElementById("stat-avg").textContent = avg.toFixed(1);
      document.getElementById("stat-best").textContent = best.toFixed(1);
    }
  }

  // ---------------------------------------------------------------------------
  // FAQ CONTENT
  // ---------------------------------------------------------------------------
  const FAQ_CONTENT = {
    "how-bootcamp-works": `Welcome to Evolve - Your IELTS & CELPIP Training Center!\n\n**What You Get:**\n‚Ä¢ 33 Writing Tests (Foundation ‚Üí Advanced)\n‚Ä¢ 33 Reading Tests (coming soon)\n‚Ä¢ AI-powered scoring on 4 criteria\n‚Ä¢ Detailed feedback and improvement tips\n‚Ä¢ Progress tracking\n\n**How It Works:**\n1. Select a test from the right panel\n2. Read the prompt and write your response\n3. Submit for instant AI scoring\n4. Review feedback and track progress\n\nStart with Foundation tests and work your way up!`,

    "how-dashboard": `**Dashboard Guide:**\n\n**Top Bar:**\n‚Ä¢ üìä Stats - Your progress and scores\n‚Ä¢ üì• Download - Export results\n‚Ä¢ üìì Notebook - Take notes\n‚Ä¢ üîó Resources - Official sites\n‚Ä¢ ‚ôªÔ∏è Reset - Clear chat\n\n**Right Panel:**\n‚Ä¢ Writing & Reading test folders\n‚Ä¢ Click to expand/collapse\n‚Ä¢ Green checkmarks = completed\n\n**Chat Area:**\n‚Ä¢ Test prompts appear here\n‚Ä¢ Type answers in the input box\n‚Ä¢ Timer and word count track your progress`,

    "speed-tips": `**Tips for Writing Faster:**\n\n1. **Plan First** - 2-3 minutes outlining saves time\n2. **Use Templates** - Memorize paragraph structures\n3. **Don't Overthink** - Write first, edit later\n4. **Learn Transitions** - Keep linking words ready\n5. **Practice Typing** - Speed matters on test day\n6. **Skip Hard Words** - Use simpler synonyms`,

    "accuracy-tips": `**Tips for Better Accuracy:**\n\n1. **Read Questions Twice** - Understand what's asked\n2. **Answer All Parts** - Don't miss sub-questions\n3. **Check Agreement** - Subject-verb matching\n4. **Vary Sentences** - Mix simple and complex\n5. **Use Examples** - Support your points\n6. **Proofread** - Save 3-5 minutes at end`,

    "vocab-tips": `**Building Your Vocabulary:**\n\n1. **Learn in Context** - Words in sentences, not lists\n2. **Word Families** - decide ‚Üí decision ‚Üí decisive\n3. **Collocations** - Learn natural word pairs\n4. **Read Daily** - News, academic articles\n5. **Use New Words** - Apply them in practice\n6. **Focus on AWL** - Academic Word List first`,

    "grammar-rules": `**Essential Grammar for IELTS:**\n\n**Tenses:**\n‚Ä¢ Present simple for facts\n‚Ä¢ Present perfect for experiences\n‚Ä¢ Past simple with time markers\n\n**Articles:**\n‚Ä¢ 'The' for specific items\n‚Ä¢ 'A/An' for first mention\n‚Ä¢ No article for general plurals\n\n**Key Structures:**\n‚Ä¢ Conditionals (If + present, will + verb)\n‚Ä¢ Passive voice for formal tone\n‚Ä¢ Relative clauses (who, which, that)`,

    "common-mistakes": `**Common Mistakes to Avoid:**\n\n1. **Run-on sentences** - Use periods!\n2. **Word repetition** - Use synonyms\n3. **Off-topic content** - Stay focused\n4. **Informal language** - No contractions\n5. **Missing conclusions** - Always summarize\n6. **Under word count** - Aim for 270-300\n7. **No paragraphs** - Structure matters`,

    "essay-structure": `**Essay Structure Template:**\n\n**Introduction (40-50 words)**\n‚Ä¢ Paraphrase the question\n‚Ä¢ State your position/thesis\n\n**Body 1 (80-100 words)**\n‚Ä¢ Topic sentence\n‚Ä¢ Explanation\n‚Ä¢ Example\n\n**Body 2 (80-100 words)**\n‚Ä¢ Topic sentence\n‚Ä¢ Explanation\n‚Ä¢ Example\n\n**Conclusion (30-40 words)**\n‚Ä¢ Summarize main points\n‚Ä¢ Restate position`,

    "ielts-clb": `**IELTS to CLB Conversion:**\n\n| IELTS | CLB Level |\n|-------|----------|\n| 8.0-9.0 | CLB 10 |\n| 7.5 | CLB 9 |\n| 7.0 | CLB 8 |\n| 6.5 | CLB 7 |\n| 6.0 | CLB 7 |\n| 5.5 | CLB 6 |\n| 5.0 | CLB 5 |\n| 4.0-4.5 | CLB 4 |\n\nExpress Entry requires CLB 7+ (IELTS 6.0) for most NOC categories.`,

    "celpip-clb": `**CELPIP to CLB Conversion:**\n\nCELPIP scores directly equal CLB levels:\n‚Ä¢ CELPIP 10 = CLB 10\n‚Ä¢ CELPIP 9 = CLB 9\n‚Ä¢ CELPIP 8 = CLB 8\n‚Ä¢ And so on...\n\nExpress Entry requires CLB 7+ for most categories.`,

    "about-program": `**About Evolve:**\n\nEvolve is designed for immigrants preparing for:\n‚Ä¢ IELTS General/Academic\n‚Ä¢ CELPIP General\n‚Ä¢ CLB assessments\n\n**Features:**\n‚Ä¢ 66 progressive tests\n‚Ä¢ Real IELTS-style prompts\n‚Ä¢ AI scoring on 4 criteria\n‚Ä¢ Detailed feedback\n‚Ä¢ Progress tracking\n\nCreated by Migrate North Academy to help you achieve your target scores.`,

    "pricing": `**Evolve Pricing:**\n\n**Annual Subscription: $150 CAD/year**\n\nIncludes:\n‚Ä¢ All 66 tests (Writing + Reading)\n‚Ä¢ Unlimited AI scoring\n‚Ä¢ Progress tracking\n‚Ä¢ Email support\n‚Ä¢ New tests added regularly\n\nClick "Unlock Full Evolve Access" to subscribe!`,

    "writing-review": `**Request Expert Review:**\n\nWant human feedback on your writing?\n\n**How to Request:**\n1. Complete a test in Evolve\n2. Copy your response\n3. Email to: info@migratenorth.ca\n4. Subject: "Writing Review Request"\n5. Include: Your answer + the prompt\n\nOur team will provide detailed feedback within 48 hours.`
  };

  function handleFAQ(faqKey) {
    const content = FAQ_CONTENT[faqKey];
    if (content) {
      ChatEngine.addBotMessage(content);
    }
  }

  // ---------------------------------------------------------------------------
  // TEST BUTTONS INITIALIZATION
  // ---------------------------------------------------------------------------
  function initTestButtons() {
    const levels = ["foundation", "intermediate", "advanced"];
    
    levels.forEach((level, levelIndex) => {
      const container = document.getElementById(`writing-${level}-tests`);
      if (!container) return;

      const tests = TEST_BANK.writing[level];
      tests.forEach((test, index) => {
        const btn = document.createElement("button");
        btn.className = "test-btn";
        const testNum = levelIndex * 11 + index + 1;
        btn.textContent = `Writing Test ${testNum}`;
        btn.dataset.testId = test.id;
        btn.dataset.level = level;

        btn.addEventListener("click", () => {
          if (!userIsSubscribed) {
            ChatEngine.addBotMessage(`üîí **Writing Test ${testNum} is locked.**\n\nSubscribe to Evolve to unlock all 66 tests with AI-powered feedback and scoring.\n\nClick the yellow "Unlock Full Evolve Access" button to get started!`);
            return;
          }

          if (currentTest.state === TestState.ACTIVE) {
            ChatEngine.addBotMessage("‚ö†Ô∏è You have a test in progress. Please submit or wait for the timer to complete.");
            return;
          }

          startTest(test.id, level);
        });

        container.appendChild(btn);
      });
    });

    // Reading tests (placeholder for now)
    levels.forEach((level, levelIndex) => {
      const container = document.getElementById(`reading-${level}-tests`);
      if (!container) return;

      for (let i = 0; i < 11; i++) {
        const btn = document.createElement("button");
        btn.className = "test-btn";
        const testNum = levelIndex * 11 + i + 1;
        btn.textContent = `Reading Test ${testNum}`;
        btn.addEventListener("click", () => {
          ChatEngine.addBotMessage(`üìñ **Reading Test ${testNum}**\n\nReading tests are coming soon! Focus on writing practice for now.`);
        });
        container.appendChild(btn);
      }
    });

    // Micro drills
    const writingMicro = document.getElementById("writing-micro-tests");
    if (writingMicro) {
      const drills = ["Paraphrase Practice", "Cohesion & Coherence", "Grammar Control", "Summarize & Condense"];
      drills.forEach(name => {
        const btn = document.createElement("button");
        btn.className = "test-btn";
        btn.textContent = `‚úèÔ∏è ${name}`;
        btn.addEventListener("click", () => {
          ChatEngine.addBotMessage(`**${name}**\n\nMicro drills are coming in the next update! These will provide targeted practice for specific skills.`);
        });
        writingMicro.appendChild(btn);
      });
    }

    const readingMicro = document.getElementById("reading-micro-tests");
    if (readingMicro) {
      const drills = ["Scanning Practice", "Skimming Practice", "Vocabulary in Context"];
      drills.forEach(name => {
        const btn = document.createElement("button");
        btn.className = "test-btn";
        btn.textContent = `üìñ ${name}`;
        btn.addEventListener("click", () => {
          ChatEngine.addBotMessage(`**${name}**\n\nReading drills are coming soon!`);
        });
        readingMicro.appendChild(btn);
      });
    }
  }

  // ---------------------------------------------------------------------------
  // UI INITIALIZATION
  // ---------------------------------------------------------------------------
  function initUI() {
    // Folder toggles
    document.querySelectorAll(".folder-header").forEach(header => {
      header.addEventListener("click", () => {
        header.classList.toggle("open");
        const folder = header.dataset.folder;
        document.getElementById(`${folder}-tests`)?.classList.toggle("open");
      });
    });

    document.querySelectorAll(".sub-folder-header").forEach(header => {
      header.addEventListener("click", () => {
        header.classList.toggle("open");
        const subfolder = header.dataset.subfolder;
        document.getElementById(`${subfolder}-tests`)?.classList.toggle("open");
      });
    });

    // FAQ buttons
    document.querySelectorAll("[data-faq]").forEach(btn => {
      btn.addEventListener("click", () => handleFAQ(btn.dataset.faq));
    });

    // Stats dropdown
    document.getElementById("btn-stats")?.addEventListener("click", () => {
      document.getElementById("stats-dropdown").classList.toggle("active");
      document.getElementById("quicklinks-dropdown").classList.remove("active");
    });
    document.getElementById("btn-stats-mobile")?.addEventListener("click", () => {
      document.getElementById("stats-dropdown").classList.toggle("active");
    });

    // Quicklinks dropdown
    document.getElementById("btn-quicklinks")?.addEventListener("click", () => {
      document.getElementById("quicklinks-dropdown").classList.toggle("active");
      document.getElementById("stats-dropdown").classList.remove("active");
    });
    document.getElementById("btn-quicklinks-mobile")?.addEventListener("click", () => {
      document.getElementById("quicklinks-dropdown").classList.toggle("active");
    });

    // Reset
    document.getElementById("btn-reset")?.addEventListener("click", () => {
      if (currentTest.state === TestState.ACTIVE) {
        if (!confirm("You have a test in progress. Reset anyway?")) return;
        stopTimer();
        endTest();
      }
      ChatEngine.clear();
      showWelcome();
    });
    document.getElementById("btn-reset-mobile")?.addEventListener("click", () => {
      ChatEngine.clear();
      showWelcome();
    });

    // Login/Logout
    document.getElementById("btn-login")?.addEventListener("click", () => {
      if (userIsSubscribed) handleLogout();
      else handleLogin();
    });
    document.getElementById("btn-login-mobile")?.addEventListener("click", () => {
      if (userIsSubscribed) handleLogout();
      else handleLogin();
    });

    // Notebook
    document.getElementById("btn-notebook")?.addEventListener("click", () => {
      document.getElementById("notebookPanel").classList.add("open");
    });
    document.getElementById("btn-notebook-mobile")?.addEventListener("click", () => {
      document.getElementById("notebookPanel").classList.add("open");
    });
    document.getElementById("notebook-close")?.addEventListener("click", () => {
      document.getElementById("notebookPanel").classList.remove("open");
    });
    document.getElementById("notebookArea")?.addEventListener("input", (e) => {
      localStorage.setItem("evolve_notebook", e.target.value);
    });
    const savedNotebook = localStorage.getItem("evolve_notebook");
    if (savedNotebook) {
      document.getElementById("notebookArea").value = savedNotebook;
    }

    // Mobile menu
    document.getElementById("btn-mobile-menu")?.addEventListener("click", () => {
      document.getElementById("mobile-menu-dropdown").classList.toggle("active");
    });

    // Unlock button
    document.getElementById("unlock-evolve")?.addEventListener("click", async () => {
      const email = prompt("Enter your email to continue to checkout:");
      if (!email || !email.includes("@")) {
        alert("Please enter a valid email address.");
        return;
      }

      ChatEngine.addBotMessage("Redirecting to secure checkout...");

      try {
        const res = await fetch(`${API_BASE}/.netlify/functions/create-evolve-checkout`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email: email.toLowerCase(), product: "evolve" })
        });

        const data = await res.json();

        if (data.url) {
          window.location.href = data.url;
        } else {
          ChatEngine.addBotMessage("Error creating checkout. Please try again or contact info@migratenorth.ca");
        }
      } catch (error) {
        ChatEngine.addBotMessage("Connection error. Please try again.");
      }
    });

    // Close dropdowns when clicking outside
    document.addEventListener("click", (e) => {
      if (!e.target.closest("#btn-stats") && !e.target.closest("#stats-dropdown") && !e.target.closest("#btn-stats-mobile")) {
        document.getElementById("stats-dropdown")?.classList.remove("active");
      }
      if (!e.target.closest("#btn-quicklinks") && !e.target.closest("#quicklinks-dropdown") && !e.target.closest("#btn-quicklinks-mobile")) {
        document.getElementById("quicklinks-dropdown")?.classList.remove("active");
      }
    });
  }

  // ---------------------------------------------------------------------------
  // WELCOME MESSAGE
  // ---------------------------------------------------------------------------
  function showWelcome() {
    ChatEngine.addBotMessage(`Welcome to the Evolve preview.\n\nThis is your IELTS and CELPIP training center with:\n‚Ä¢ 66 progressive tests\n‚Ä¢ Micro drills for targeted practice\n‚Ä¢ Vocabulary builder\n‚Ä¢ AI-powered scoring\n\nTo unlock full access, please log in or subscribe.\n\nClick any button in the dashboard to explore what's included!`);
  }

  // ---------------------------------------------------------------------------
  // INITIALIZATION
  // ---------------------------------------------------------------------------
  async function init() {
    console.log("Evolve initializing...");
    ChatEngine.init();
    initUI();
    initTestButtons();

    // Check for payment redirect
    const params = new URLSearchParams(window.location.search);
    if (params.get("paid") === "true" && params.get("email")) {
      const email = decodeURIComponent(params.get("email")).toLowerCase();
      console.log("Payment detected, auto-logging in:", email);
      
      localStorage.setItem("evolve_user_email", email);
      currentUserEmail = email;
      applyAccess(true, email);
      loadProgress();
      
      window.history.replaceState({}, document.title, window.location.pathname);
      
      showWelcome();
      setTimeout(() => {
        ChatEngine.addBotMessage("üéâ **Payment successful!** Your Evolve subscription is now active.\n\nYou have full access to:\n‚Ä¢ All 33 writing tests\n‚Ä¢ AI-powered scoring\n‚Ä¢ Detailed feedback\n‚Ä¢ Progress tracking\n\nSelect a test from the right panel to begin!");
      }, 500);
      return;
    }

    if (params.get("cancelled") === "true") {
      window.history.replaceState({}, document.title, window.location.pathname);
      showWelcome();
      setTimeout(() => {
        ChatEngine.addBotMessage("Payment was cancelled. No worries - click 'Unlock Full Evolve Access' when you're ready to subscribe.");
      }, 500);
      return;
    }

    // Check for existing login
    const savedEmail = localStorage.getItem("evolve_user_email");
    if (savedEmail) {
      console.log("Found saved email, checking entitlement...");
      const hasAccess = await checkEntitlement(savedEmail);
      if (hasAccess) {
        applyAccess(true, savedEmail);
        loadProgress();
        showWelcome();
        ChatEngine.addBotMessage(`Welcome back! Select a test to continue practicing.`);
        return;
      }
    }

    applyAccess(false, null);
    showWelcome();
    console.log("Evolve ready!");
  }

  // Start the app
  document.addEventListener("DOMContentLoaded", init);

  return { ChatEngine, startTest };
})();
</script>
<script src="./evolve-phase2-complete-integration.js"></script>
</body>
</html>
