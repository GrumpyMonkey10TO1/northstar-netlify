<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>North Star GPS Lite — IELTS Reading</title>
  <meta name="robots" content="noindex,nofollow" />
  <style>
    :root { color-scheme: light; }
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 840px; margin: auto; background:#f7f7f9; }
    h1 { font-size: 22px; margin: 0 0 12px; }
    #chat { background:#fff; border: 1px solid #e5e7eb; border-radius: 12px; padding: 12px; height: 520px; overflow-y: auto; margin-bottom: 10px; white-space: pre-wrap; box-shadow: 0 6px 24px rgba(0,0,0,.04); }
    #controls { display: flex; gap: 8px; }
    #msg { flex: 1; padding: 12px; font-size: 16px; border-radius: 10px; border:1px solid #d1d5db; }
    #send { padding: 12px 16px; font-size: 16px; border-radius: 10px; border:1px solid transparent; cursor: pointer; background:#111827; color:#fff; }
    #send:disabled { opacity: .5; cursor: not-allowed; }
    .line { margin: 8px 0; padding: 8px 10px; border-radius: 10px; }
    .user { text-align: right; background:#eef2ff; }
    .bot { text-align: left; background:#f3f4f6; }
    .muted { color:#6b7280; font-size: 13px; text-align:center; margin-top:6px; }
  </style>
</head>
<body>

  <h1>North Star GPS Lite — IELTS Reading</h1>

  <div id="chat"></div>

  <div id="controls">
    <input id="msg" type="text" placeholder="Type here..." autocomplete="off" />
    <button id="send">Send</button>
  </div>

  <div class="muted">Tip: Short questions get faster answers.</div>

  <script>
    // ====== CONFIG ======
    const ENDPOINT = "/.netlify/functions/chat"; // same-origin Netlify Function
    // ====================

    const chatBox = document.getElementById("chat");
    const input = document.getElementById("msg");
    const sendBtn = document.getElementById("send");

    function addMessage(role, text) {
      const line = document.createElement("div");
      line.className = `line ${role}`;
      line.textContent = text;
      chatBox.appendChild(line);
      chatBox.scrollTop = chatBox.scrollHeight;
      scheduleHeightPing();
    }

    async function sendMessage() {
      const text = input.value.trim();
      if (!text) return;
      addMessage("user", text);
      input.value = "";
      input.focus();
      sendBtn.disabled = true;

      try {
        const res = await fetch(ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message: text, mode: "lite" })
        });

        const raw = await res.text();
        if (!res.ok) throw new Error(`HTTP ${res.status}: ${raw}`);

        let data;
        try { data = JSON.parse(raw); } catch { throw new Error(`Bad JSON: ${raw}`); }

        const reply =
          data.reply ||
          data.message ||
          data.content ||
          (data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content) ||
          "No reply from server.";

        addMessage("bot", reply);
      } catch (err) {
        addMessage("bot", `Error. Try again.\n${String(err)}`);
        console.error(err);
      } finally {
        sendBtn.disabled = false;
      }
    }

    sendBtn.addEventListener("click", sendMessage);
    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter") sendMessage();
    });

    // Welcome line
    addMessage("bot", "Welcome to North Star GPS Lite. Academic or General Training?");

    // ======== AUTO-RESIZE (post height to parent for iframe embeds) =====
function postHeight() {
  try {
    const h =
      document.documentElement.scrollHeight ||
      document.body.scrollHeight ||
      800;
    window.parent.postMessage({ height: h }, "*");
  } catch (_) {}
}

let heightPing;                           // <-- line ~107: capital P

function scheduleHeightPing() {           // <-- capital P
  clearTimeout(heightPing);               // <-- capital P
  heightPing = setTimeout(postHeight, 50);
}

window.addEventListener("load", postHeight);
window.addEventListener("resize", scheduleHeightPing);

const observer = new MutationObserver(scheduleHeightPing);
observer.observe(document.body, {
  childList: true,
  subtree: true,
  characterData: true
});

setInterval(postHeight, 1000); // safety ping
// ====================================================================

    // ================================================================

  </script>

</body>
</html>
